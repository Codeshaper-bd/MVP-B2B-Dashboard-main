parameters:
  - name: bicepFileLocation
    type: string
  - name: paramFile
    type: string
  - name: apiAppServiceName
    type: string
  - name: resourceGroupName
    type: string
  - name: ARTIFACT_NAME
    default: "drop"
  - name: ENVIRONMENT
    default: "dev"

steps:
  # Download the Build Artifact
  - download: current
    artifact: "${{ parameters.ARTIFACT_NAME }}"
    displayName: "Download Application Artifact"

  - task: AzureCLI@2
    displayName: "Configuring AppSettings and Connection String"
    inputs:
      azureSubscription: "azure-connect"
      scriptType: "bash"
      scriptLocation: "inlineScript"
      inlineScript: |
        MAIN_TEMPLATE_FILE="$(Pipeline.Workspace)/${{ parameters.ARTIFACT_NAME }}/main.json"
        PARAM_FILE="$(Pipeline.Workspace)/${{ parameters.ARTIFACT_NAME }}/params/${{ parameters.paramFile }}"
        RESOURCE_GROUP="${{ parameters.resourceGroupName }}"

        echo "Main Template File Path: $MAIN_TEMPLATE_FILE"
        echo "Parameter File Path: $PARAM_FILE"
        echo "Resource Group: $RESOURCE_GROUP"

        if [ ! -f "$MAIN_TEMPLATE_FILE" ]; then
          echo "Error: Main template file not found at $MAIN_TEMPLATE_FILE"
          exit 1
        fi

        if [ ! -f "$PARAM_FILE" ]; then
          echo "Error: Parameter file not found at $PARAM_FILE"
          exit 1
        fi

        echo "Starting deployment..."
        if ! az deployment group create --resource-group "$RESOURCE_GROUP" --template-file "$MAIN_TEMPLATE_FILE" --parameters @"$PARAM_FILE"; then
          echo "Deployment to $RESOURCE_GROUP failed."
          exit 1
        fi


        echo "Deployment to $RESOURCE_GROUP succeeded."

  - script: |
      VERSION_TAG=$(xargs < "$(Pipeline.Workspace)/${{ parameters.ARTIFACT_NAME }}/version.txt")
      echo "VERSION_TAG from version.txt: '$VERSION_TAG'"
      echo "##vso[task.setvariable variable=VERSION_TAG]$VERSION_TAG"
    displayName: "Extract VERSION_TAG from version.txt"

  # Debug: Check the VERSION_TAG value
  - script: |
      echo "VERSION_TAG: $(VERSION_TAG)"
    displayName: "Debug: Check VERSION_TAG Value"

  # Deploy to Azure Web App using Container
  - task: AzureWebAppContainer@1
    displayName: "Deploy Azure Web App Container"
    inputs:
      azureSubscription: "azure-connect"
      appName: "${{ parameters.apiAppServiceName }}"
      resourceGroupName: "${{ parameters.resourceGroupName }}"
      containers: "fennecapp.azurecr.io/fennecapp-web:$(VERSION_TAG)" # Ensure your ACR is used
